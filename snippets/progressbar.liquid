{%- assign current_inventory = product.selected_or_first_available_variant.inventory_quantity -%}
{%- assign total_stock = 50 -%}
{%- assign is_fake = true -%}
{%- assign stock_count = 19 -%}

{%- if current_inventory > 0 -%}
  {%- assign stock_count = current_inventory -%}
  {%- assign is_fake = false -%}
  {%- if stock_count > total_stock -%}
    {%- assign total_stock = stock_count | plus: 20 -%}
  {%- endif -%}
{%- endif -%}

<div class="scarcity-bar-container" id="scarcity-bar-{{ section.id }}">
  <p class="scarcity-text">
    Restam apenas <span class="count" id="stock-count-{{ section.id }}">{{ stock_count }}</span> unidades!
  </p>
  <div class="scarcity-bar-bg">
    <div class="scarcity-bar-fill" id="stock-fill-{{ section.id }}" style="width: {{ stock_count | times: 100 | divided_by: total_stock }}%;"></div>
  </div>
</div>

<script>
(function() {
  var isFake = {{ is_fake }};
  var sectionId = "{{ section.id }}";
  var countElement = document.getElementById("stock-count-" + sectionId);
  var fillElement = document.getElementById("stock-fill-" + sectionId);
  var currentCount = parseInt(countElement.innerText);
  var total = {{ total_stock }};

  function updateBar() {
    var percentage = (currentCount / total) * 100;
    fillElement.style.width = percentage + "%";
    
    // Color logic: Redder as it gets lower
    if (percentage < 30) {
      fillElement.style.background = "linear-gradient(90deg, #D32F2F, #B71C1C)";
    } else {
        fillElement.style.background = "linear-gradient(90deg, #FF9800, #F44336)";
    }
  }

  // Initial update
  updateBar();

  if (isFake) {
    // Fake decreasing logic
    var interval = setInterval(function() {
      // Decrease if > 3 with some randomness
      if (currentCount > 3 && Math.random() > 0.5) { 
        currentCount--;
        countElement.innerText = currentCount;
        updateBar();
        
        // Flash effect
        countElement.style.color = "#FF0000";
        setTimeout(function() { countElement.style.color = "#D32F2F"; }, 500);
      } else if (currentCount <= 3) {
          clearInterval(interval); // Stop at 3
      }
    }, 7000); // Decrease check every 7 seconds
  }
})();
</script>
